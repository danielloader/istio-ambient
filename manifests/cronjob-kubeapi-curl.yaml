apiVersion: batch/v1
kind: CronJob
metadata:
  name: cronjob-kubeapi-client
spec:
  schedule: "* * * * *"
  successfulJobsHistoryLimit: 60
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: kubeapi-client
          containers:
            - name: curl
              image: curlimages/curl:8.8.0
              imagePullPolicy: IfNotPresent
              resources:
                limits:
                  memory: "128Mi"
                  cpu: "100m"
              command: ["/bin/sh", "-c", "--"]
              args: ['until curl -s -v -f -o /dev/null https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT}/apis/apps/v1 --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt --header "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"; do echo "------ Trying again ------"; done']
          restartPolicy: Never
